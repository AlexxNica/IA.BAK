#!/bin/sh
# Sets up git repo for a specified SHARD
set -e

SHARD="$1"
BAREREPO="$2"
GITDIR="/home/$SHARD/$shard.git"
if [ -z "$SHARD" ] || [ -z "$BAREREPO" ]; then
	echo "Usage: setupshardrepo SHARDn /path/to/SHARDn.git" >&2
	exit 1
fi
shard="$(echo "$SHARD" | tr A-Z a-z)"

useradd "$SHARD"
mkdir /home/"$SHARD"
cd /home/"$SHARD"
mv "$BAREREPO" "$GITDIR"
cat > /home/"$SHARD"/.gitconfig <<EOF
[user]
	email = $SHARD@ia-bak
	name = $SHARD
EOF
mkdir /home/"$SHARD"/.ssh
chown -R "$SHARD:$SHARD" /home/"$SHARD"

ln -sf /usr/local/IA.BAK/hooks/update "$GITDIR/hooks/update"
ln -sf /usr/local/IA.BAK/hooks/post-receive "$GITDIR/hooks/post-receive"

/usr/local/IA.BAK/update-authorized_keys "$SHARD"
