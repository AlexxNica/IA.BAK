#!/bin/sh
# Gets stats for a specified SHARD
set -e

SHARD="$1"
if [ -z "$SHARD" ]; then
	echo "Usage: shardstats SHARDn" >&2
	exit 1
fi
shard="$(echo "$SHARD" | tr A-Z a-z)"

DIR="/srv/shard/$shard"
# need a non-bare clone to run git-annex info . in
if [ ! -d "$DIR" ]; then
	mkdir -p "$(dirname "$DIR")"
	(cd "$(dirname "$DIR")" && git clone /home/"$SHARD"/"$shard".git && git config user.email stats@example.com && git config user.name stats)
else
	(cd "$DIR" && git fetch origin master git-annex && git merge origin/master)
fi
cd "$DIR"
mkdir -p /var/www/html/stats/
TMP="$(tempfile)"
git annex info . | grep "numcopies " > "$TMP"
chmod 644 "$TMP"
mv "$TMP" /var/www/html/stats/"$SHARD"

grep 'numcopies +' /var/www/html/stats/"$SHARD" | perl -le 'while (<>) { ($mult, $cnt) = m/.*numcopies \+(\d+):\s+(\d+)/; $total=$total+($cnt*$mult) }; print localtime()."\t".$total' >> /var/www/html/stats/"$SHARD".filestransferred

GEOLIST="$(tempfile)"
for ip in $(zgrep 'ia-bak' /var/log/auth.log.* /var/log/auth.log | grep 'Accepted publickey' | grep "$SHARD" | awk '{print $11}' | sort -u); do
	TMP="$(tempfile)"
	wget -q -O "$TMP" "freegeoip.net/json/${ip}"
	cat "$TMP" | sed 's/{.*\"country_code\"/{\"country_code\"/g' | sed 's/,\"latitude\".*/}/g' >> "$GEOLIST"
	rm -rf "$TMP"
done
chmod 644 "$GEOLIST"
mv "$GEOLIST" /var/www/html/stats/"$SHARD".geolist

CONNS="$(tempfile)"
zgrep -h 'ia-bak' /var/log/auth.log.* /var/log/auth.log  | grep 'Accepted publickey' | grep "$SHARD" | perl -pe 's/:.*/:00/' | uniq  -c > "$CONNS"
chmod 644 "$CONNS"
mv "$CONNS" /var/www/html/stats/"$SHARD".clientconnsperhour

# git repo grows in size fast while it's filling up; and compresses very
# well. Save clients the transfer.
cd /home/"$SHARD"/"$shard".git && su "$SHARD" -c git gc --aggressive
