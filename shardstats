#!/bin/bash
# Gets stats for a specified SHARD, or ALL
set -e

: ${STATS_DIR:=/var/www/html/stats}
: ${GEOIP_DIR:=/srv/geoip}
: ${SHARD_DIR:=/srv/shard}
: ${CLIENT_DIR:=/usr/local/IA.BAK/client}
: ${UTIL_DIR:=/usr/local/IA.BAK/utils}
: ${PUBKEYS_DIR:=/usr/local/IA.BAK/pubkeys}
: ${GRAPHITE_HOST:=127.0.0.1}
: ${GRAPHITE_PORT:=2003}
DATE=$(date +%s)

sendStat () {
	stat=$1
	value=$2
	stamp=${3:-$DATE}
	if [ -z "$stat" -o -z "$value" ]; then
		echo "missing argument to sendStat $1 $2"
		exit
	fi
	MSG="iabak.shardstats.${stat}.${shard} ${value} ${stamp}"
	echo "${MSG}"
	echo "${MSG}" | nc -q 0 "${GRAPHITE_HOST}" "${GRAPHITE_PORT}"
}

SHARD="$1"
if [ -z "$SHARD" ]; then
	echo "Usage: shardstats SHARDn" >&2
	exit 1
fi
shard="$(echo "$SHARD" | tr A-Z a-z)"

if [ "$SHARD" != ALL ]; then
	DIR="${SHARD_DIR}/$shard"
	# need a non-bare clone to run git-annex info . in
	if [ ! -d "$DIR" ]; then
		mkdir -p "$(dirname "$DIR")"
		(cd "$(dirname "$DIR")" && git clone "/home/$SHARD/$shard.git")
		(cd "$DIR" && git config user.email stats@example.com && git config user.name stats && git config gc.auto 0)
		chown -R "$SHARD:$SHARD" "$DIR"
	else
		(cd "$DIR" && su "$SHARD" -c -- "git fetch origin master git-annex" && su "$SHARD" -c -- "git merge origin/master")
	fi
	cd "$DIR"
	mkdir -p ${STATS_DIR}/
	INFOTMP="$(tempfile)"
	su "$SHARD" -c -- "git annex info . --bytes" > "$INFOTMP"

	TMP="$(tempfile)"
	grep "numcopies " "$INFOTMP" > "$TMP"
	chmod 644 "$TMP"
	mv "$TMP" "${STATS_DIR}/$SHARD"

	TMP="$(tempfile)"
	grep " -- " "$INFOTMP" | grep -v 00000000-0000-0000-0000-000000000001 | perl -pe 's/^\s+//' > "$TMP"
	chmod 644 "$TMP"
	mv "$TMP" "${STATS_DIR}/$SHARD".leaderboard

	TMP="$(tempfile)"
	perl -ne 'if (/size of annexed files in working tree: ([.0-9]+)/) { print (int($1/10000000000)/100)."\n" }' < "$INFOTMP" > "$TMP"
	chmod 644 "$TMP"
	mv "$TMP" "${STATS_DIR}/$SHARD.size"

	EXPIRETMP="$(tempfile)"
	su "$SHARD" -c -- "git annex expire --no-act 21d web:never origin:never" > "$EXPIRETMP"
	chmod 644 "$EXPIRETMP"
	mv "$EXPIRETMP" "${STATS_DIR}/$SHARD".expire
	
	rm -f "$INFOTMP"
fi

NUMTMP="$(tempfile)"
if [ "$SHARD" != ALL ]; then
	GREPSHARD="$SHARD"
	grep 'numcopies +' "${STATS_DIR}/$SHARD" > "$NUMTMP"
else
	GREPSHARD="SHARD"
	grep -h 'numcopies +' "${STATS_DIR}"/SHARD[0-9]* > "$NUMTMP"
	STATTMP="$(tempfile)"
	echo "numcopies stats: " > "$STATTMP"
	for n in $(seq 0 10); do
		perl -le 'BEGIN { $want=shift; $total=0 }; while (<>) { ($mult, $cnt) = m/.*numcopies \+(\d+):\s+(\d+)/; $total=$total+$cnt if $mult == $want } END { print "\tnumcopies +$want: $total" }' $n "$NUMTMP" >> "$STATTMP"
	done
	chmod 644 "$STATTMP"
	mv "$STATTMP" "${STATS_DIR}/ALL"

	TMP="$(tempfile)"
	perl -ne '$n+=$_; END { print "$n\n" }' "${STATS_DIR}"/SHARD[0-9]*.size > "$TMP"
	chmod 644 "$TMP"
	mv "$TMP" "${STATS_DIR}/ALL.size"
	
	TMP="$(tempfile)"
	(cd "${PUBKEYS_DIR}"; git pull)
	sort -r -n "${STATS_DIR}"/SHARD[0-9]*.leaderboard | "$UTIL_DIR/uuidtoemail" "$PUBKEYS_DIR" | "$UTIL_DIR/combineemails" | sort -rn > "$TMP"
	chmod 644 "$TMP"
	mv "$TMP" "${STATS_DIR}/ALL.leaderboard"
	
	TMP="$(tempfile)"
	find "${STATS_DIR}"/SHARD[0-9]* -printf '%f\n' | grep -v \\. > "$TMP"
	chmod 644 "$TMP"
	mv "$TMP" "${STATS_DIR}/ALL.shardlist"
fi

sendStat "filesize" "$(<${STATS_DIR}/${SHARD}.size)"

while read size uuid rest; do
	sendStat "leaderboard.${uuid}" $(echo $size | sed -e 's/://')
done < "${STATS_DIR}/$SHARD.leaderboard"

counts=()
total=0
filecount=0
maxcopies=0
while read mult count; do
	counts[$mult]=$count
	total=$(($total+($count*$mult)))
	filecount=$(($filecount+$count))
	if (($mult>$maxcopies)); then
		maxcopies=$mult
	fi
done < <(tail -n +2 "${STATS_DIR}/$SHARD" | sed -e "s/\s*numcopies [+]\([0-9]*\):/\1/g")
sendStat "numcopies.total" "${total}"
sendStat "filecount" "${filecount}"
i=0
while (($i<=$maxcopies)); do
	sendStat "numcopies.${i}" "${counts[$i]:-0}"
	i=$(($i+1))
done

perl -le 'while (<>) { ($mult, $cnt) = m/.*numcopies \+(\d+):\s+(\d+)/; $total=$total+($cnt*$mult) }; print localtime()."\t".$total' < "$NUMTMP" >> "${STATS_DIR}/$SHARD.filestransferred"
data=$(tail -1 "${STATS_DIR}/$SHARD.filestransferred")
date="$(echo "$data" | cut -f 1)"
count="$(echo "$data" | cut -f 2)"
sendStat "filestransfered" "${count}" "$(date --date "${date}" +%s)"

mkdir -p "${GEOIP_DIR}"
GEOLIST="$(tempfile)"
for ip in $(zgrep 'Accepted publickey' /var/log/auth.log.* /var/log/auth.log | grep "$GREPSHARD" | awk '{print $11}' | sort -u); do
	if [ ! -e "${GEOIP_DIR}/$ip" ]; then
		TMP="$(tempfile)"
		wget -q -O "$TMP" "freegeoip.net/json/${ip}"
		mv "$TMP" "${GEOIP_DIR}/$ip"
	fi
	cat "${GEOIP_DIR}/$ip" | sed 's/{.*\"country_code\"/{\"country_code\"/g' | sed 's/,\"latitude\".*/}/g' >> "$GEOLIST"
done
chmod 644 "$GEOLIST"
mv "$GEOLIST" "${STATS_DIR}/$SHARD.geolist"

CONNS="$(tempfile)"
zgrep -h "Accepted publickey for $GREPSHARD" /var/log/auth.log.* /var/log/auth.log | perl -pe 's/:.*/:00/' | uniq  -c > "$CONNS"
chmod 644 "$CONNS"
data=$(tail -1 "$CONNS" | sed -e 's/^\s*\([0-9]*\) /\1\t/g' -e 's/:00$/:59:59/g')
count="$(echo "$data" | cut -f 1)"
if [ -z "$count" ]; then
	count=0
fi
date="$(echo "$data" | cut -f 2)"
sendStat "connections" "${count}" "$(date --date "${date}" +%s)"
mv "$CONNS" "${STATS_DIR}/$SHARD.clientconnsperhour"

TMP="$(tempfile)"
if [ "$SHARD" != ALL ]; then
	perl -e 'open(EXP, shift()); open(LEAD, shift()); while (<LEAD>) { my ($size, $uuid)=m/^(\d+): ([^ ]+) -- /; $sz{$uuid}=$size } foreach (<EXP>) { my ($uuid)=m/^expire ([^ ]+) /; my $sz=$sz{$uuid}; $sz=0 if ! defined $sz; print "$sz: $_" }' "${STATS_DIR}/$SHARD".expire "${STATS_DIR}/$SHARD".leaderboard | sort -rn > "$TMP"
else
	cat ${STATS_DIR}/SHARD*.expireleaderboard | sort -rn > "$TMP"
fi
chmod 644 "$TMP"
mv "$TMP" "${STATS_DIR}/$SHARD".expireleaderboard

CTMP="$(tempfile)"
if [ "$SHARD" != ALL ]; then
	ls -1 > "$CTMP"
else
	(cd "${CLIENT_DIR}"; git pull)
	for s in $(grep ' active$' "${CLIENT_DIR}/repolist" | cut -d ' ' -f 1 | tr a-z A-Z); do
		cat "${STATS_DIR}/$s.collections" >> "$CTMP"
	done
	for s in $(grep -v ' active$' "${CLIENT_DIR}/repolist" | cut -d ' ' -f 1 | tr a-z A-Z); do
		cat "${STATS_DIR}/$s.collections" >> "$CTMP"
	done
fi
chmod 644 "$CTMP"
mv "$CTMP" "${STATS_DIR}/$SHARD.collections"

(cd ${STATS_DIR} && tar czf "../stats.tar.gz.new" .)
mv "${STATS_DIR}/../stats.tar.gz.new" "${STATS_DIR}/../stats.tar.gz"
