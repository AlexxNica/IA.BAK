#!/bin/sh
# Gets stats for a specified SHARD
set -e

SHARD="$1"
if [ -z "$SHARD" ]; then
	echo "Usage: shardstats SHARDn" >&2
	exit 1
fi
shard="$(echo "$SHARD" | tr A-Z a-z)"

DIR="/srv/shard/$shard"
# need a non-bare glone to run git-annex info . in
if [ ! -d "$DIR" ]; then
	mkdir -p "$(dirname "$DIR")"
	(cd "$(dirname "$DIR")" && git clone /home/"$SHARD"/"$shard".git && git config user.email stats@example.com && git config user.name stats)
else
	(cd "$DIR" && git fetch origin master git-annex && git merge origin/master)
fi
cd "$DIR"
mkdir -p /var/www/html/stats/
TMP="$(tempfile)"
git annex info . | grep "numcopies " > "$TMP"
chmod 644 "$TMP"
mv "$TMP" /var/www/stats/"$SHARD"
